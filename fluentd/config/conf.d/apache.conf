<filter k8s.apache.**>
  @type           parser
  key_name        log
  reserve_data    true
  <parse>
    @type         multi_format
    <pattern>
      format      regexp
      expression  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
      time_key    time
      time_format %d %b %H:%M:%S.%L
    </pattern>
    <pattern>
      format      regexp
      expression  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] \\"(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?\\" (?<code>[^ ]*) (?<size>[^ ]*)(?: \\"(?<referer>[^\"]*)\\" \\"(?<agent>[^\"]*)\\")?$
      time_key    time
      time_format %d %b %H:%M:%S.%L
    </pattern>
    <pattern>
      format      regexp
      expression  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] \\\\\\"(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?\\\\\\" (?<code>[^ ]*) (?<size>[^ ]*)(?: \\\\\\"(?<referer>[^\"]*)\\\\\\" \\\\\\"(?<agent>[^\"]*)\\\\\\")?$
      time_key    time
      time_format %d %b %H:%M:%S.%L
    </pattern>
    <pattern>
      format      regexp
      expression  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^ ]*) +\S*)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
      time_key    time
      time_format %d/%b/%Y:%H:%M:%S %z
    </pattern>
    <pattern>
      format      regexp
      expression  ^\[[^ ]* (?<time>[^\]]*)\] \[(?<level>[^\]]*)\](?: \[pid (?<pid>[^\]]*)\])?( \[client (?<client>[^\]]*)\])? (?<log>.*)$
    </pattern>
    <pattern>
      format none
    </pattern>
  </parse>
</filter>

<filter k8s.apache.**>
  @type record_transformer
  <record>
    source via-k8s-apache
  </record>
</filter>

<match k8s.apache.**>
  @type copy
  <store>
    @id                 apache_star_star_elasticsearch
    @type               elasticsearch
    host                "#{ENV['ELASTICSEARCH_HOST']}"
    port                "#{ENV['ELASTICSEARCH_PORT']}"
    user                "#{ENV['FLUENTD_USER']}"
    password            "#{ENV['FLUENTD_PASSWORD']}"
    include_timestamp   true
    logstash_format     true
    logstash_prefix     apache
    logstash_dateformat %Y%m%d
    include_tag_key     true
    type_name           access_log_apache_k8s
    tag_key             @log_name
    <buffer>
        flush_interval  1s # for testing
    </buffer>
  </store>
</match>
