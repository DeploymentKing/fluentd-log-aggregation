<filter k8s.redis.**>
  @type           parser
  key_name        log
  reserve_data    true
  <parse>
    @type         multi_format
    <pattern>
      format      regexp
      expression  ^(?<pid>\[\d*\]) (?<time>\d{2}\s\w{2,}\s\d{2}:\d{2}:\d{2}\.\d{3}) (?<level>.) (?<log>.*)$
      time_key    time
      time_format %d %b %H:%M:%S.%L
    </pattern>
    <pattern>
      format      regexp
      expression  ^(?<log>.*)$
      time_key    time
      time_format %d %b %H:%M:%S.%L
    </pattern>
    <pattern>
      format none
    </pattern>
  </parse>
</filter>

<filter k8s.redis.**>
  @type record_transformer
  <record>
    source via-k8s-redis
  </record>
</filter>

<match k8s.redis.**>
  @type copy
  <store>
    @id                 redis_star_star_elasticsearch
    @type               elasticsearch
    host                "#{ENV['ELASTICSEARCH_HOST']}"
    port                "#{ENV['ELASTICSEARCH_PORT']}"
    user                "#{ENV['FLUENTD_USER']}"
    password            "#{ENV['FLUENTD_PASSWORD']}"
    include_timestamp   true
    logstash_format     true
    logstash_prefix     redis
    logstash_dateformat %Y%m%d
    include_tag_key     true
    type_name           access_log_redis_k8s
    tag_key             @log_name
    <buffer>
      flush_interval  1s # for testing
    </buffer>
  </store>
</match>
