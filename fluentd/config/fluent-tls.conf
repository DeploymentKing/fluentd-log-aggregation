#####################################
## SOURCES
##
<source>
  @id           fluentd_aggregation
  @type         forward
  port          "#{ENV['FLUENTD_AGGREGATOR_PORT']}"
  bind          0.0.0.0

  <transport tls>
    version                 TLSv1_2
    cert_path               /fluentd/certs/fluentd.crt
    private_key_path        /fluentd/certs/fluentd.key
    private_key_passphrase  "#{ENV['FLUENTD_PRIVATE_KEY_PASSPHRASE']}"
  </transport>

  <security>
    shared_key    "#{ENV['FLUENTD_SHARED_KEY']}"
    self_hostname "#{ENV['FLUENTD_HOSTNAME']}"
  </security>
</source>

#####################################
## PERFORM FLUENT-BIT ROUTING OPTIONS
##
<match kube.**>
  @type route
  remove_tag_prefix kube.var.log.containers

  <route redis**>
    copy
    @label @REDIS
  </route>
  <route apache**>
    copy
    @label @APACHE
  </route>
  <route kube**>
    copy
    @label @K8S
  </route>
  <route **>
    copy
  </route>
</match>

#####################################
## PERFORM KUBERNETES ROUTING OPTIONS
##
<match etcd-**>
  @type route
  <route **>
    copy
    @label @K8S
  </route>
</match>
<match fluent-bit-**>
  @type route
  <route **>
    copy
    @label @K8S
  </route>
</match>
<match heapster-**>
  @type route
  <route **>
    copy
    @label @K8S
  </route>
</match>
<match influxdb-**>
  @type route
  <route **>
    copy
    @label @K8S
  </route>
</match>
<match kube-**>
  @type route
  <route **>
    copy
    @label @K8S
  </route>
</match>
<match kubernetes-dashboard-**>
  @type route
  <route **>
    copy
    @label @K8S
  </route>
</match>

#####################################
## REDIS
##
<label @REDIS>
  <filter **>
    @type           parser
    key_name        log
    <parse>
      @type         multi_format
      <pattern>
        format      regexp
        expression  ^(?<pid>\[\d*\]) (?<time>\d{2}\s\w{2,}\s\d{2}:\d{2}:\d{2}\.\d{3}) (?<level>.) (?<log>.*)$
        time_key    time
        time_format %d %b %H:%M:%S.%L
      </pattern>
      <pattern>
        format      regexp
        expression  ^(?<log>.*)$
        time_key    time
        time_format %d %b %H:%M:%S.%L
      </pattern>
      <pattern>
        format none
      </pattern>
    </parse>
  </filter>
  <filter **>
    @type record_transformer
    <record>
      source via-k8s-redis
    </record>
  </filter>
  <match **>
    @type copy
    <store>
      @id                 redis_star_star_elasticsearch
      @type               elasticsearch
      host                "#{ENV['ELASTICSEARCH_HOST']}"
      port                "#{ENV['ELASTICSEARCH_PORT']}"
      user                "#{ENV['FLUENTD_USER']}"
      password            "#{ENV['FLUENTD_PASSWORD']}"
      include_timestamp   true
      logstash_format     true
      logstash_prefix     redis
      logstash_dateformat %Y%m%d
      include_tag_key     true
      type_name           access_log_redis_k8s
      tag_key             @log_name
      <buffer>
        flush_interval  1s # for testing
      </buffer>
    </store>
  </match>
</label>

#####################################
## APACHE
##
<label @APACHE>
  <filter **>
    @type           parser
    key_name        log
    <parse>
      @type         multi_format
      <pattern>
        format      regexp
        expression  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
        time_key    time
        time_format %d %b %H:%M:%S.%L
      </pattern>
      <pattern>
        format      regexp
        expression  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] \\"(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?\\" (?<code>[^ ]*) (?<size>[^ ]*)(?: \\"(?<referer>[^\"]*)\\" \\"(?<agent>[^\"]*)\\")?$
        time_key    time
        time_format %d %b %H:%M:%S.%L
      </pattern>
      <pattern>
        format      regexp
        expression  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^ ]*) +\S*)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
        time_key    time
        time_format %d/%b/%Y:%H:%M:%S %z
      </pattern>
      <pattern>
        format      regexp
        expression  ^\[[^ ]* (?<time>[^\]]*)\] \[(?<level>[^\]]*)\](?: \[pid (?<pid>[^\]]*)\])?( \[client (?<client>[^\]]*)\])? (?<log>.*)$
      </pattern>
      <pattern>
        format none
      </pattern>
    </parse>
  </filter>
  <filter **>
    @type record_transformer
    <record>
      source via-k8s-apache
    </record>
  </filter>
  <match **>
    @type copy
    <store>
      @id                 apache_star_star_elasticsearch
      @type               elasticsearch
      host                "#{ENV['ELASTICSEARCH_HOST']}"
      port                "#{ENV['ELASTICSEARCH_PORT']}"
      user                "#{ENV['FLUENTD_USER']}"
      password            "#{ENV['FLUENTD_PASSWORD']}"
      include_timestamp   true
      logstash_format     true
      logstash_prefix     apache
      logstash_dateformat %Y%m%d
      include_tag_key     true
      type_name           access_log_apache_k8s
      tag_key             @log_name
      <buffer>
          flush_interval  1s # for testing
      </buffer>
    </store>
  </match>
</label>

#####################################
## KUBERNETES
##
<label @K8S>
  <filter **>
    @type record_transformer
    <record>
      source via-k8s
    </record>
  </filter>
  <match **>
    @type copy
    <store>
      @id                 kube_star_star_elasticsearch
      @type               elasticsearch
      host                "#{ENV['ELASTICSEARCH_HOST']}"
      port                "#{ENV['ELASTICSEARCH_PORT']}"
      user                "#{ENV['FLUENTD_USER']}"
      password            "#{ENV['FLUENTD_PASSWORD']}"
      include_timestamp   true
      logstash_format     true
      logstash_prefix     k8s
      logstash_dateformat %Y%m%d
      include_tag_key     true
      type_name           access_log_k8s
      tag_key             @log_name
      <buffer>
          flush_interval  1s # for testing
      </buffer>
    </store>
  </match>
</label>

#####################################
## OUTPUTS
##
<match fluent.*>
  @type copy
  <store>
    @id                 fluent_star_elasticsearch
    @type               elasticsearch
    host                "#{ENV['ELASTICSEARCH_HOST']}"
    port                "#{ENV['ELASTICSEARCH_PORT']}"
    user                "#{ENV['FLUENTD_USER']}"
    password            "#{ENV['FLUENTD_PASSWORD']}"
    include_timestamp   true
    logstash_format     true
    logstash_prefix     fluentd
    logstash_dateformat %Y%m%d
    include_tag_key     true
    type_name           access_log
    tag_key             @log_name
    <buffer>
        flush_interval  1s # for testing
    </buffer>
  </store>
  <store>
    @id   fluent_star_stdout
    @type stdout
  </store>
</match>

<match via-fluentd-gem>
  @type copy
  <store>
    @id                 via_fluentd_gem_elasticsearch
    @type               elasticsearch
    host                "#{ENV['ELASTICSEARCH_HOST']}"
    port                "#{ENV['ELASTICSEARCH_PORT']}"
    user                "#{ENV['FLUENTD_USER']}"
    password            "#{ENV['FLUENTD_PASSWORD']}"
    include_timestamp   true
    logstash_format     true
    logstash_prefix     gem
    logstash_dateformat %Y%m%d
    include_tag_key     true
    type_name           access_log_gem
    tag_key             @log_name
    <buffer>
        flush_interval  1s # for testing
    </buffer>
  </store>
</match>

<match via-td-agent>
  @type copy
  <store>
    @id                 via_td_agent_elasticsearch
    @type               elasticsearch
    host                "#{ENV['ELASTICSEARCH_HOST']}"
    port                "#{ENV['ELASTICSEARCH_PORT']}"
    user                "#{ENV['FLUENTD_USER']}"
    password            "#{ENV['FLUENTD_PASSWORD']}"
    include_timestamp   true
    logstash_format     true
    logstash_prefix     agent
    logstash_dateformat %Y%m%d
    include_tag_key     true
    type_name           access_log_agent
    tag_key             @log_name
    <buffer>
        flush_interval  1s # for testing
    </buffer>
  </store>
</match>

<match via-td-agent-bit>
  @type copy
  <store>
    @id                 via_td_agent_bit_elasticsearch
    @type               elasticsearch
    host                "#{ENV['ELASTICSEARCH_HOST']}"
    port                "#{ENV['ELASTICSEARCH_PORT']}"
    user                "#{ENV['FLUENTD_USER']}"
    password            "#{ENV['FLUENTD_PASSWORD']}"
    include_timestamp   true
    logstash_format     true
    logstash_prefix     bit
    logstash_dateformat %Y%m%d
    include_tag_key     true
    type_name           access_log_bit
    tag_key             @log_name
    <buffer>
        flush_interval  1s # for testing
    </buffer>
  </store>
</match>
